<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time File Uploader</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1, h2 {
            color: #0056b3;
        }
        #uploadContainer {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        #fileInput {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 10px;
        }
        #uploadButton {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        #uploadButton:hover {
            background-color: #0056b3;
        }
        #statusMessage {
            margin-top: 10px;
            font-weight: bold;
            color: #dc3545; /* Red for errors, can change dynamically */
        }
        #fileList {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 150px;
            border: 1px solid #eee;
        }
        .file-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .file-item img {
            max-width: 80px;
            max-height: 80px;
            margin-right: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            object-fit: contain;
        }
        .file-item a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
        }
        .file-item a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div id="uploadContainer">
        <h1>Upload Files</h1>
        <input type="file" id="fileInput">
        <button id="uploadButton">Upload</button>
        <p id="statusMessage"></p>
    </div>

    <h2>Uploaded Files</h2>
    <div id="fileList">
        <p>No files uploaded yet.</p>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Get references to HTML elements
        const fileInput = document.getElementById('fileInput');
        const uploadButton = document.getElementById('uploadButton');
        const statusMessage = document.getElementById('statusMessage');
        const fileListDiv = document.getElementById('fileList');

        // Initialize Socket.IO client connection
        // It will automatically try to connect to the server that served this page
        const socket = io();

        // Add event listener to the upload button
        uploadButton.addEventListener('click', uploadFile);

        /**
         * Handles the file upload process when the button is clicked.
         */
        async function uploadFile() {
            const file = fileInput.files[0]; // Get the first selected file

            // Validate if a file was selected
            if (!file) {
                statusMessage.textContent = 'Please select a file to upload.';
                statusMessage.style.color = '#dc3545'; // Set status message color to red
                return;
            }

            // Create a FormData object to send the file.
            // FormData is used to build a set of key/value pairs representing fields
            // and their values, which can then be sent to the server.
            const formData = new FormData();
            formData.append('myFile', file); // 'myFile' must match the field name in app.post('/upload', upload.single('myFile'), ...)

            try {
                statusMessage.textContent = 'Uploading...';
                statusMessage.style.color = '#007bff'; // Set status message color to blue

                // Send the file to the server using the Fetch API
                const response = await fetch('/upload', {
                    method: 'POST', // Use POST method for uploads
                    body: formData  // The FormData object contains the file
                });

                // Check if the upload was successful (HTTP status 2xx)
                if (response.ok) {
                    statusMessage.textContent = 'Upload successful!';
                    statusMessage.style.color = '#28a745'; // Set status message color to green
                    fileInput.value = ''; // Clear the file input field
                    // No need to manually add to list here, because the server
                    // will emit a Socket.IO event that triggers addFileToDisplay().
                } else {
                    // If upload failed, get the error message from the server
                    const errorText = await response.text();
                    statusMessage.textContent = `Upload failed: ${errorText}`;
                    statusMessage.style.color = '#dc3545'; // Set status message color to red
                }
            } catch (error) {
                // Catch any network or other unexpected errors
                statusMessage.textContent = `Error during upload: ${error.message}`;
                statusMessage.style.color = '#dc3545'; // Set status message color to red
                console.error('Upload error:', error);
            }
        }

        /**
         * Dynamically adds a file item to the displayed list.
         * @param {object} file - An object containing file details (name, path).
         */
        function addFileToDisplay(file) {
            // Remove "No files uploaded yet." message if present
            const noFilesMessage = fileListDiv.querySelector('p');
            if (noFilesMessage && noFilesMessage.textContent === 'No files uploaded yet.') {
                fileListDiv.innerHTML = '';
            }

            const div = document.createElement('div');
            div.className = 'file-item';

            // Check if the file is an image based on its extension
            const isImage = /\.(jpeg|jpg|gif|png|webp)$/i.test(file.name);

            if (isImage) {
                const img = document.createElement('img');
                img.src = file.path;
                img.alt = file.name;
                div.appendChild(img);
            }

            const link = document.createElement('a');
            link.href = file.path;
            link.textContent = file.name;
            link.target = '_blank'; // Open the file in a new browser tab
            link.title = `Download ${file.name}`; // Add a tooltip

            div.appendChild(link);
            fileListDiv.prepend(div); // Add the new file item to the beginning of the list
        }

        /**
         * Fetches the initial list of uploaded files from the server when the page loads.
         */
        async function fetchFiles() {
            try {
                const response = await fetch('/files'); // Make a GET request to the /files endpoint
                if (response.ok) {
                    const files = await response.json(); // Parse the JSON response
                    fileListDiv.innerHTML = ''; // Clear existing list to prevent duplicates
                    if (files.length === 0) {
                        fileListDiv.innerHTML = '<p>No files uploaded yet.</p>';
                    } else {
                        // Iterate through the files and add them to the display
                        files.forEach(file => addFileToDisplay(file));
                    }
                } else {
                    console.error('Failed to fetch files:', response.status, response.statusText);
                    fileListDiv.innerHTML = '<p style="color: #dc3545;">Error loading files.</p>';
                }
            } catch (error) {
                console.error('Network error fetching files:', error);
                fileListDiv.innerHTML = '<p style="color: #dc3545;">Network error loading files.</p>';
            }
        }

        // --- Socket.IO Client-side Event Listeners ---

        // Listen for the 'newFileUploaded' event emitted by the server
        socket.on('newFileUploaded', (fileInfo) => {
            console.log('New file received via WebSocket:', fileInfo);
            addFileToDisplay(fileInfo); // Add the new file to the display immediately
        });

        // --- Initial Page Load ---

        // Fetch files when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', fetchFiles);
    </script>
</body>
</html>